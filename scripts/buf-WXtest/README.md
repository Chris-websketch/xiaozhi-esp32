# BluFi 蓝牙配网小程序

基于 ESP32 BluFi 协议的微信小程序，用于通过蓝牙为 ESP32 设备配置 WiFi 网络。

## 功能特性

- 🔍 扫描附近的 BluFi 设备
- 🔐 DH 密钥交换安全协商
- 📡 AES-128-CFB 加密传输 WiFi 凭据
- ✅ 实时显示配网状态

## 目录结构

```
buf-WXtest/
├── app.js                      # 小程序入口
├── app.json                    # 全局配置
├── app.wxss                    # 全局样式
├── pages/
│   └── index/                  # 配网页面
│       ├── index.js
│       ├── index.wxml
│       ├── index.wxss
│       └── index.json
└── utils/
    └── blufi.js                # BluFi 核心模块（精简单文件版本）
```

## 使用方法

### 1. 导入项目

使用微信开发者工具打开 `buf-test` 目录。

### 2. 配置 AppID

在 `project.config.json` 中填入你的小程序 AppID，或使用测试号。

### 3. 运行小程序

1. 确保 ESP32 设备已进入配网模式（广播名称包含 `BLUFI`）
2. 点击「扫描设备」按钮
3. 选择要配网的设备
4. 输入 WiFi 名称和密码
5. 点击「开始配网」等待完成

## 技术说明

### BluFi 协议

- **服务 UUID**: `0000FFFF-0000-1000-8000-00805F9B34FB`
- **写入特征 (P2E)**: `0000FF01-0000-1000-8000-00805F9B34FB`
- **通知特征 (E2P)**: `0000FF02-0000-1000-8000-00805F9B34FB`

### 安全机制

| 特性 | 说明 |
|------|------|
| 密钥交换 | Diffie-Hellman 1024-bit |
| 数据加密 | AES-128-CFB |
| 完整性校验 | CRC16-CCITT (初始值 0) |

### 配网流程

```
小程序                              ESP32
   │                                  │
   │  1. 扫描发现设备                  │
   │ ─────────────────────────────>   │
   │                                  │
   │  2. 建立 BLE 连接                 │
   │ <─────────────────────────────>  │
   │                                  │
   │  3. DH 密钥协商                   │
   │ <─────────────────────────────>  │
   │                                  │
   │  4. 发送 WiFi SSID (加密)         │
   │ ─────────────────────────────>   │
   │                                  │
   │  5. 发送 WiFi 密码 (加密)         │
   │ ─────────────────────────────>   │
   │                                  │
   │  6. 发送连接请求                  │
   │ ─────────────────────────────>   │
   │                                  │
   │  7. 返回连接结果                  │
   │ <─────────────────────────────   │
```

## 常见问题

| 问题 | 解决方案 |
|------|----------|
| 扫描不到设备 | 确认设备已进入配网模式，蓝牙已开启 |
| 连接失败 | 靠近设备重试，检查蓝牙权限 |
| 安全协商失败 | 查看控制台日志，检查 DH 参数 |
| 配网超时 | 确认 WiFi 密码正确 |

## 调试

在微信开发者工具控制台查看 `[BluFi]` 前缀的日志输出。

ESP32 端可通过串口监控 `BLUFI_CLASS` TAG 的日志。

## 参考文档

- [BluFi 蓝牙配网小程序对接文档](../../docs/BluFi蓝牙配网小程序对接文档.md)
- [ESP32 BluFi 官方文档](https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-guides/blufi.html)

## 许可证

MIT License
