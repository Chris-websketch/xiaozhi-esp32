# 任务描述
修复MQTT连接断开和订阅失败问题

## 问题分析
1. **订阅失败**：ESP-IDF MQTT API返回消息ID（>=0表示成功），但代码错误判断为`== 0`
2. **周期性断连**：服务器每~30秒断开连接，设备无自动重连机制
3. **Keep-alive不匹配**：设置90秒但服务器30秒超时

## 实施的修改

### 1. esp-ml307/esp_mqtt.cc
- **修复API返回值判断**：
  - `Publish()`：改为`msg_id >= 0`判断成功
  - `Subscribe()`：改为`msg_id >= 0`判断成功
  - `Unsubscribe()`：改为`msg_id >= 0`判断成功
  - 添加详细的成功/失败日志

- **启用自动重连**：
  - 添加`mqtt_config.network.reconnect_timeout_ms = 5000`
  - 添加`mqtt_config.network.disable_auto_reconnect = false`
  - 确保断连后5秒内自动重连

- **增强事件日志**：
  - `MQTT_EVENT_CONNECTED`：添加成功连接日志
  - `MQTT_EVENT_DISCONNECTED`：改为WARN级别，提示自动重连
  - `MQTT_EVENT_BEFORE_CONNECT`：添加连接中日志
  - `MQTT_EVENT_SUBSCRIBED`：添加订阅成功日志
  - `MQTT_EVENT_ERROR`：改为ERROR级别

### 2. main/notifications/mqtt_notifier.cc
- **调整Keep-alive**：从90秒 → 25秒 → 15秒（最终优化）
- **优化订阅**：
  - QoS从2降为1（兼容性更好）
  - 改进日志输出，清晰显示成功/失败状态

## 预期效果
- ✅ 订阅操作正确返回成功状态
- ✅ 连接断开后5秒内自动重连
- ✅ 通过15秒心跳保持连接活跃（避免服务器20秒超时断连）
- ✅ 详细日志便于问题诊断

## 验证步骤
1. 编译并烧录固件
2. 观察启动日志确认订阅成功
3. 监控是否仍出现断连
4. 确认断连后自动重连成功
5. 长期运行测试稳定性

---
**任务状态**：实施完成并优化 ✅  
**初次完成**：2025-10-17 10:54  
**最终优化**：2025-10-17 11:03

## 后续优化记录

### Keep-alive时间调优（2025-10-17 11:03）
**问题**：测试发现服务器实际超时约20秒，25秒心跳仍会断连  
**分析**：
- WiFi模式使用EspMqtt（ESP-IDF实现），心跳依赖ESP32定时器
- 4G模式使用Ml307Mqtt（模组内部实现），模组有自动重连机制
- WiFi网络特性导致心跳可能延迟，需要更短的间隔

**解决**：将Keep-alive从25秒缩短到15秒  
**预期**：15秒心跳 < 20秒服务器超时，理论上可完全避免断连

### Keep-alive未生效调试（2025-10-17 11:20）
**问题**：实测断连间隔仍为~20.5秒，说明15秒Keep-alive未生效  
**验证步骤**：
1. 自动重连机制已完美工作 ✅
2. 新增日志正常输出 ✅
3. 但断连间隔仍为20秒，心跳未提前

**调试措施**：在`esp_mqtt.cc`第37行添加日志输出实际配置值
```cpp
ESP_LOGI(TAG, "MQTT keep-alive configured: %d seconds", keep_alive_seconds_);
```
预期看到：`MQTT keep-alive configured: 15 seconds`  
如果看到60秒，说明`SetKeepAlive(15)`未被调用
